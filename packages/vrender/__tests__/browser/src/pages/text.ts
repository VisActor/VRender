import {
  createStage,
  createText,
  global,
  getTextBounds,
  createLine,
  createRect,
  createCircle,
  IGraphic,
  createGroup,
  vglobal,
  createWrapText
} from '@visactor/vrender';
import { addShapesToStage, colorPools } from '../utils';

// global.setEnv('browser');

const textStr =
  'è›‹ç³•åƒèµ·æ¥åƒå·²ç»æ”¾äº†å¾ˆå¤šå¹´ä¼¼çš„ã€‚é‚£å¤©æ™šä¸Šè¾¾åŠ›ç¥žæ°”æ´»çŽ°åœ°åœ¨èµ·å±…å®¤é‡Œèµ°æ¥èµ°åŽ»ï¼Œå‘å®¶äººå±•ç¤ºä»–é‚£å¥—æ–°æ ¡æœã€‚æ–¯æ¢…å»·ä¸­å­¦çš„ç”·ç”Ÿåˆ¶æœæ˜¯æ£•çº¢è‰²ç‡•å°¾æœï¼Œæ©™è‰²çŸ­ç¯ç¬¼è£¤å’Œä¸€é¡¶å«ç¡¬è‰å¸½2çš„æ‰å¹³è‰å¸½ã€‚ä»–ä»¬è¿˜é…äº†ä¸€æ”¯å¤šèŠ‚çš„æ‰‹æ–ï¼Œè¶è€å¸ˆä¸æ³¨æ„æ—¶ç”¨æ¥äº’ç›¸æ‰“æ–—ï¼Œè¿™ä¹Ÿè®¸æ˜¯å¯¹æœªæ¥ç”Ÿæ´»çš„ä¸€ç§å¾ˆå¥½çš„è®­ç»ƒå§ã€‚å¼—å†œå§¨çˆ¶çœ‹ç€èº«ç©¿å´­æ–°ç¯ç¬¼è£¤çš„è¾¾åŠ›ï¼Œä»–çš„å£°éŸ³éƒ½æ²™å“‘äº†ï¼Œä»–è¯´è¿™æ˜¯ä»–å¹³ç”Ÿæ„Ÿåˆ°æœ€è‡ªè±ªçš„ä¸€åˆ»ã€‚ä½©å¦®å§¨å¦ˆçªç„¶å“­èµ·æ¥ï¼Œå¥¹è¯´å¥¹çš„å®è´ç–™ç˜©å·²ç»é•¿å¤§äº†ï¼Œé•¿å¾—è¿™ä¹ˆå¸…ï¼Œç®€ç›´è®©å¥¹ä¸èƒ½ç›¸ä¿¡ã€‚å“ˆåˆ©å´ä¸æ•¢å¼€å£ã€‚ä¸ºäº†å¼ºå¿ä½ä¸ç¬‘ï¼Œä»–çš„ä¸¤æ¡è‚‹éª¨éƒ½å¿«æŠ˜æ–­äº†ã€‚ç¬¬äºŒå¤©æ—©ä¸Šå“ˆåˆ©æ¥åƒæ—©é¥­æ—¶ï¼Œå‘çŽ°åŽ¨æˆ¿é‡Œæœ‰ä¸€è‚¡éš¾é—»çš„å‘³å„¿ã€‚è¿™æ°”å‘³ä¼¼ä¹Žæ˜¯ä»Žæ±¡æ°´æ± é‡Œçš„ä¸€åªå¤§é“ç›†é‡Œæ•£å‘å‡ºæ¥çš„ã€‚ä»–åŽ»çœ‹äº†ä¸€çœ¼ï¼Œå‘çŽ°ä¸€ç›†ç°é»‘è‰²çš„æ°´é‡Œæ³¡ç€åƒç ´æŠ¹å¸ƒä¼¼çš„ä¸œè¥¿ã€‚ã€Œè¿™æ˜¯ä»€ä¹ˆï¼Ÿã€ä»–é—®ä½©å¦®å§¨å¦ˆã€‚å¥¹æŠŠå˜´å”‡æŠ¿ç´§ï¼Œæ¯å½“å“ˆåˆ©å¤§èƒ†é—®é—®é¢˜æ—¶ï¼Œå¥¹æ€»æ˜¯è¿™æ ·ã€‚ã€Œä½ çš„æ–°æ ¡æœå‘€ã€‚ã€å¥¹è¯´ã€‚å“ˆåˆ©åˆæœç›†é‡Œæ‰«äº†ä¸€çœ¼ã€‚ã€Œå“¦ï¼Œã€ä»–è¯´ï¼Œã€Œæˆ‘ä¸çŸ¥é“è¿˜å¾—æ³¡å¾—è¿™ä¹ˆæ¹¿ã€‚ã€ã€Œåˆ«å†’å‚»æ°”ï¼Œã€ä½©å¦®å§¨å¦ˆæ–¥è´£è¯´ï¼Œã€Œæˆ‘æŠŠè¾¾åŠ›çš„æ—§è¡£æœæŸ“å¥½ç»™ä½ ç”¨ã€‚ç­‰æˆ‘æŸ“å¥½ä»¥åŽï¼Œç©¿èµ·æ¥å°±ä¼šè·Ÿåˆ«äººçš„ä¸€æ¨¡ä¸€æ ·ã€‚ã€å“ˆåˆ©å¯¹æ­¤éžå¸¸æ€€ç–‘ï¼Œä½†ä»–è¿˜æ˜¯è§‰å¾—æœ€å¥½ä¸è¦è·Ÿå¥¹äº‰è®ºã€‚ä»–åä¸‹æ¥åƒæ—©é¥­æ—¶ï¼Œç«­åŠ›ä¸åŽ»æƒ³ç¬¬ä¸€å¤©åŽ»çŸ³å¢™ä¸­å­¦ä¸Šå­¦è‡ªå·±ä¼šæ˜¯ä»€ä¹ˆæ¨¡æ ·ï¼Œå…«æˆåƒæŠ«ç€å¤§è±¡çš„æ—§è±¡çš®å§ã€‚è¾¾åŠ›å’Œå¼—å†œå§¨çˆ¶è¿›æ¥æ—¶ï¼Œéƒ½å› ä¸ºå“ˆåˆ©é‚£å¥—æ–°æ ¡æœæ•£å‘çš„å‘³é“çš±èµ·äº†é¼»å­ã€‚å¼—å†œå§¨çˆ¶åƒé€šå¸¸ä¸€æ ·æ‰“å¼€æŠ¥çº¸ï¼Œè¾¾åŠ›åˆ™æŠŠä»–ä»Žä¸ç¦»èº«çš„æ–¯æ¢…å»·æ‰‹æ–å•ªçš„ä¸€å£°æ”¾åˆ°æ¡Œä¸Šã€‚ä»–ä»¬å¬åˆ°ä¿¡ç®±å’”å“’å“äº†ä¸€å£°ï¼Œä¸€äº›ä¿¡è½åˆ°å¤§é—¨å£çš„æ“¦è„šåž«ä¸Šã€‚ã€ŒåŽ»æ‹¿ä¿¡ï¼Œè¾¾åŠ›ã€‚ã€å¼—å†œå§¨çˆ¶ä»ŽæŠ¥çº¸åŽè¾¹è¯´ã€‚ã€Œå«å“ˆåˆ©åŽ»æ¡ã€‚ã€ã€Œå“ˆåˆ©åŽ»æ¡ã€‚ã€ã€Œè¾¾åŠ›åŽ»æ¡ã€‚ã€ã€Œç”¨ä½ çš„æ–¯æ¢…å»·æ‰‹æ–èµ¶ä»–åŽ»æ¡ã€‚ã€å“ˆåˆ©èº²é—ªç€æ–¯æ¢…å»·æ‰‹æ–ï¼ŒåŽ»æ¡ä¿¡ã€‚æ“¦è„šåž«ä¸Šæœ‰ä¸‰æ ·é‚®ä»¶ï¼šä¸€å°æ˜¯å¼—å†œå§¨çˆ¶çš„å§å§çŽ›å§¬å§‘å¦ˆå¯„æ¥çš„æ˜Žä¿¡ç‰‡ï¼Œå¥¹çŽ°åœ¨åœ¨æ€€ç‰¹å²›3åº¦å‡ï¼›å¦ä¸€å°æ˜¯çœ‹æ¥åƒè´¦å•çš„æ£•è‰²ä¿¡å°ï¼›è¿˜æœ‰ä¸€å°æ˜¯å¯„ç»™å“ˆåˆ©çš„ä¿¡ã€‚å“ˆåˆ©æŠŠä¿¡æ¡èµ·æ¥ï¼Œç›®ä¸è½¬ç›åœ°ç›¯ç€çœ‹ï¼Œå¿ƒé‡Œåƒæœ‰ä¸€æ ¹å¾ˆç²—çš„æ©¡çš®ç­‹å˜£çš„ä¸€å£°å¼¹äº†èµ·æ¥ï¼Œå—¡å—¡ç›´å“ã€‚æ´»åˆ°çŽ°åœ¨ï¼Œä»Žæ¥æ²¡æœ‰äººç»™ä»–å†™è¿‡ä¿¡ã€‚è¿™å°ä¿¡å¯èƒ½æ˜¯è°å†™çš„å‘¢ï¼Ÿä»–æ²¡æœ‰æœ‹å‹ï¼Œæ²¡æœ‰å¦å¤–çš„äº²æˆšï¼Œä»–æ²¡æœ‰å€Ÿä¹¦è¯ï¼Œå› æ­¤ä¸ä¼šæ”¶åˆ°å›¾ä¹¦é¦†å‚¬è¿˜å›¾ä¹¦çš„é€šçŸ¥å•ã€‚å¯çŽ°åœ¨ç¡®å®žæœ‰ä¸€å°ä¿¡ï¼Œåœ°å€æ¸…æ¸…æ¥šæ¥šï¼Œä¸ä¼šæœ‰é”™ï¼šè¨é‡Œéƒ¡å°æƒ é‡‘åŒºå¥³è´žè·¯ï¼”å·æ¥¼æ¢¯ä¸‹çš„ç¢—æŸœå“ˆåˆ©æ³¢ç‰¹å…ˆç”Ÿæ”¶ä¿¡å°æ˜¯ç”¨åŽšé‡çš„ç¾Šçš®çº¸åšçš„ï¼Œåœ°å€æ˜¯ç”©ç¿¡ç¿ ç»¿çš„å¢¨æ°´å†™çš„ã€‚æ²¡æœ‰è´´é‚®ç¥¨ã€‚å“ˆåˆ©ç”¨é¢¤æŠ–çš„æ‰‹æŠŠä¿¡å°ç¿»è½¬è¿‡æ¥ï¼Œåªè§ä¸Šè¾¹æœ‰ä¸€å—èœ¡å°ã€ä¸€ä¸ªç›¾ç‰Œçº¹ç« ï¼Œå¤§å†™ã€Œï¼¨ã€å­—æ¯çš„å‘¨å›´åœˆç€ä¸€å¤´ç‹®å­ã€ä¸€åªé¹°ã€ä¸€åªç¾å’Œä¸€æ¡è›‡ã€‚ã€Œå°å­ï¼Œå¿«æ‹¿è¿‡æ¥ï¼ã€å¼—å†œå§¨çˆ¶åœ¨åŽ¨æˆ¿é‡Œå–Šèµ·æ¥ï¼Œã€Œä½ åœ¨å¹²ä»€ä¹ˆï¼Œåœ¨æ£€æŸ¥é‚®åŒ…æœ‰æ²¡æœ‰ç‚¸å¼¹å—ï¼Ÿã€ä»–å¼€äº†ä¸ªçŽ©ç¬‘ï¼Œè‡ªå·±ä¹Ÿå’¯å’¯åœ°ç¬‘å¼€äº†ã€‚å“ˆåˆ©å›žåˆ°åŽ¨æˆ¿é‡Œï¼Œç›®å…‰ä¸€ç›´ç›¯ç€ä»–çš„é‚£å°ä¿¡ã€‚ä»–æŠŠè´¦å•å’Œæ˜Žä¿¡ç‰‡é€’ç»™å¼—å†œå§¨çˆ¶ï¼Œç„¶åŽåä¸‹æ¥ï¼Œæ…¢æ…¢æ‹†å¼€ä»–é‚£ä¸ªé»„è‰²çš„ä¿¡å°ã€‚å¼—å†œå§¨çˆ¶æ‹†å¼€æœ‰è´¦å•çš„ä¿¡å°ï¼ŒåŽŒæ¶åœ°å“¼äº†ä¸€å£°ï¼ŒåˆæŠŠæ˜Žä¿¡ç‰‡è½»è½»ç¿»è½¬è¿‡æ¥ã€‚ã€ŒçŽ›å§¬ç—…å€’äº†ï¼Œã€ä»–å¯¹ä½©å¦®å§¨å¦ˆè¯´ï¼Œã€Œåƒäº†æœ‰é—®é¢˜çš„æ²¹èžºâ€¦â€¦ã€ã€Œè€çˆ¸ï¼ã€è¾¾åŠ›çªç„¶è¯´ï¼Œã€Œè€çˆ¸ï¼Œå“ˆåˆ©æ”¶åˆ°ä»€ä¹ˆä¸œè¥¿äº†ï¼ã€å“ˆåˆ©åˆšè¦æ‰“å¼€ä»–é‚£å°å†™åœ¨åŽšé‡ç¾Šçš®çº¸ä¸Šçš„ä¿¡ï¼Œä¿¡å´è¢«å¼—å†œå§¨çˆ¶ä¸€æŠŠä»Žæ‰‹ä¸­æŠ¢è¿‡åŽ»äº†ã€‚ã€Œé‚£æ˜¯å†™ç»™æˆ‘çš„ï¼ã€å“ˆåˆ©è¯´ï¼Œæƒ³æŠŠä¿¡å¤ºå›žæ¥ã€‚ã€Œè°ä¼šç»™ä½ å†™ä¿¡ï¼Ÿã€å¼—å†œå§¨çˆ¶è®¥è®½åœ°è¯´ï¼Œç”¨ä¸€åªæ‰‹æŠŠä¿¡çº¸æŠ–å¼€ï¼Œæœå®ƒçž¥äº†ä¸€çœ¼ã€‚ä»–çš„è„¸ä¸€ä¸‹å­ç”±çº¢å˜é’ï¼Œæ¯”çº¢ç»¿ç¯å˜å¾—è¿˜å¿«ã€‚äº‹æƒ…åˆ°è¿™é‡Œå¹¶æ²¡ç»“æŸã€‚å‡ ç§’é’Ÿä¹‹å†…ä»–çš„è„¸å°±å˜å¾—åƒç°è‰²çš„éº¦ç‰‡ç²¥ä¸€æ ·ç°ç™½äº†ã€‚ã€Œä½©â€”â€”ä½©â€”â€”ä½©å¦®ï¼ã€ä»–æ°”å–˜åååœ°è¯´ã€‚è¾¾åŠ›æƒ³æŠŠä¿¡æŠ¢è¿‡æ¥çœ‹ï¼Œå¯æ˜¯å¼—å†œå§¨çˆ¶æŠŠä¿¡ä¸¾å¾—è€é«˜ï¼Œä»–å¤Ÿä¸ç€ã€‚ä½©å¦®å§¨å¦ˆå¥½å¥‡åœ°æŠŠä¿¡æ‹¿è¿‡åŽ»ï¼Œåˆšçœ‹ç¬¬ä¸€è¡Œï¼Œå¥¹å°±å¥½åƒè¦æ™•å€’äº†ã€‚å¥¹æŠ“ä½å–‰å’™ï¼Œå™Žäº†ä¸€ä¸‹ï¼Œåƒè¦èƒŒè¿‡æ°”åŽ»ã€‚ã€Œå¾·æ€ç¤¼ï¼å“Žå‘€ï¼æˆ‘çš„å¤©â€¦â€¦å¾·æ€ç¤¼ï¼ã€ä»–ä»¬ä¿©ä½ çœ‹æˆ‘ï¼Œæˆ‘çœ‹ä½ ï¼Œéƒ½ä¸è¯´è¯ï¼Œä¼¼ä¹Žå¿˜äº†å“ˆåˆ©å’Œè¾¾åŠ›è¿˜åœ¨å±‹é‡Œã€‚è¾¾åŠ›æ˜¯ä¸ä¹ æƒ¯è¢«äººå†·è½çš„ï¼Œä»–ç”¨æ–¯æ¢…å»·æ‰‹æ–æœä»–çˆ¶äº²çš„å¤´ä¸Šç‹ ç‹ åœ°æ•²äº†ä¸€ä¸‹ã€‚ã€Œæˆ‘è¦çœ‹é‚£å°ä¿¡ã€‚ã€ä»–å¤§å£°è¯´ã€‚ã€Œæˆ‘è¦çœ‹ã€‚ã€å“ˆåˆ©æ°”å‘¼å‘¼åœ°è¯´ï¼Œã€Œå› ä¸ºé‚£å°ä¿¡æ˜¯å†™ç»™æˆ‘çš„ã€‚ã€ã€Œä½ ä»¬ä¿©ï¼Œç»Ÿç»Ÿç»™æˆ‘å‡ºåŽ»ã€‚ã€å¼—å†œå§¨çˆ¶ç”¨ä½Žæ²‰è€Œæ²™å“‘çš„å£°éŸ³è¯´ï¼ŒæŠŠä¿¡é‡æ–°å¡žåˆ°ä¿¡å°é‡Œã€‚å“ˆåˆ©æ²¡æœ‰åŠ¨ã€‚ã€Œæˆ‘è¦æˆ‘çš„ä¿¡ï¼ã€ä»–å¤§å«è¯´ã€‚ã€Œè®©æˆ‘çœ‹ï¼ã€è¾¾åŠ›å‘½ä»¤è¯´ã€‚ã€Œå‡ºåŽ»ï¼ã€å¼—å†œå§¨çˆ¶å¼äº†èµ·æ¥ï¼Œæªä½å“ˆåˆ©å’Œè¾¾åŠ›çš„è„–é¢†ï¼ŒæŠŠä»–ä»¬ä¿©æ‰”åˆ°äº†èµ°å»Šé‡Œï¼Œç °åœ°ä¸€';

function performance(stage: any) {
  // vglobal.measureTextMethod = 'quick';
  const textList = new Array(3000).fill(0).map(item => {
    const start = Math.floor(textStr.length * Math.random());
    // return createText({
    //   text: textStr.substring(start, Math.min(textStr.length - start - 1, 10)),
    //   fill: true,
    //   fontSize: 16
    // })
    return createText({
      text: new Array(10)
        .fill(0)
        .map(item => String.fromCharCode(97 + Math.floor(Math.random() * 24)))
        .join(''),
      fill: true,
      fontSize: 16
    });
  });

  const group = createGroup({});
  textList.forEach(t => group.add(t));
  // stage.defaultLayer.add(group);
  console.time();
  const bounds = group.AABBBounds;
  console.timeEnd();
  console.log(bounds);
}

export const page = () => {
  const graphics: IGraphic[] = [];
  const t = createText({
    text: ['2022å¹´ä¸–ç•Œå›½å®¶å’Œåœ°åŒºGDPæ€»é‡ ðŸš€'],
    ellipsis: '...',
    fill: 'linear-gradient(90deg, #215F97 0%, #FF948F 100%)',
    fontSize: 24,
    fontWeight: 'bold',
    textAlign: 'center',
    textBaseline: 'top',
    width: 308,
    lineHeight: '150%',
    fontStyle: 'normal',
    underline: 1,
    stroke: 'transparent',
    fontFamily: '',
    wrap: true,
    whiteSpace: 'no-wrap',
    maxLineWidth: 308,
    x: 154,
    y: 0
  });
  console.log(t, t.cliped);
  graphics.push(t);
  // t.animate().to({ maxLineWidth: 0 }, 3000, 'linear');

  const tt = createText({
    x: 971.9754981994629,
    y: -213.8625716268361,
    textAlign: 'center',
    _debug_bounds: true,
    textBaseline: 'middle',
    text: ['ç»†åˆ†'],
    underline: 1,
    underlineOffset: 0,
    underlineDash: [2, 2],
    fontSize: 16,
    whiteSpace: 'normal',
    graphicAlign: 'center',
    graphicBaseline: 'middle',
    fill: '#000',
    ignoreBuf: true,
    fontFamily: 'D-Din',
    maxLineWidth: 120,
    heightLimit: 999999,
    // angle: 0.6,
    // anchor: [971.9754981994629, -213.8625716268361],
    visible: true,
    background: '#F54A45'
  });
  console.log(tt);
  const g = createGroup({
    // angle: 0.6
    x: -600,
    y: 600
  });
  g.add(tt);

  graphics.push(g);

  graphics.push(
    createText({
      x: 300,
      y: 200,
      fill: {
        gradient: 'linear',
        x0: 0,
        y0: 0,
        x1: 1,
        y1: 1,
        stops: [
          { offset: 0, color: 'green' },
          { offset: 0.5, color: 'orange' },
          { offset: 1, color: 'red' }
        ]
      },
      background: 'red',
      backgroundCornerRadius: 10,
      text: ['è¿™æ˜¯ä¸€è¡Œæ–‡å­—'],
      fontSize: 36,
      textBaseline: 'top'
    })
  );

  const text = createText({
    x: 500,
    y: 200,
    fill: colorPools[5],
    // text: ['Tffg'],
    text: ['è¿™æ˜¯åž‚aaaç›´textabcè¿™aaaaaæ˜¯ä»€ä¹ˆ', 'è¿™æ˜¯é˜¿è¨å§†abcaaaaa'],
    wordBreak: 'break-word',
    maxLineWidth: 200,
    // ellipsis: '',
    direction: 'vertical',
    stroke: 'green',
    // wordBreak: 'break-word',
    // maxLineWidth: 200,
    // ellipsis: '',
    // direction: 'vertical',
    // fontSize: 120,
    // stroke: 'green',
    // lineWidth: 100,
    // lineHeight: 30,
    // lineThrough: 1,
    // underline: 1,
    textAlign: 'left',
    textBaseline: 'middle'
    // textBaseline: 'bottom'
    // scaleX: 2,
    // scaleY: 2
  });
  graphics.push(text);
  const circle = createCircle({
    x: 500,
    y: 200,
    fill: 'black',
    radius: 2
  });
  graphics.push(circle);

  const wt = createText({
    text: ['çœ/è‡ªæ²»åŒºå­—æ®µä¿¡æ¯jfkdlafjkdag'],
    ellipsis: '...',
    fill: 'red',
    fontSize: 68,
    fontWeight: 'bold',
    textAlign: 'center',
    textBaseline: 'top',
    width: 1628,
    maxLineWidth: 1628,
    x: 814,
    y: 100,
    _debug_bounds: true,
    wrap: true
  });
  graphics.push(wt);
  console.log('wt', wt);

  const rect = createRect({
    x: t.AABBBounds.x1,
    y: t.AABBBounds.y1,
    width: t.AABBBounds.width(),
    height: t.AABBBounds.height(),
    stroke: 'red',
    lineWidth: 1
  });
  graphics.push(rect);

  const stage = createStage({
    canvas: 'main',
    autoRender: true
  });

  window.visualViewport.addEventListener('resize', e => {
    console.log(e.currentTarget.scale);
    stage.setDpr(e.currentTarget.scale * window.devicePixelRatio);
  });

  graphics.forEach(g => {
    stage.defaultLayer.add(g);
  });

  const btn = document.createElement('button');
  btn.innerHTML = 'ç‚¹å‡»';
  document.body.appendChild(btn);
  btn.addEventListener('click', () => {
    performance(stage);
  });
};
